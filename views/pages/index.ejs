<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title> Social GES</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">

    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
</head>

<body>

    <%- include('../partials/header'); %>

        <div class="container-fluid">
            <div class="row">
                <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                    <div class="position-sticky pt-3">
                        <ul class="nav flex-column">
                            <li class="nav-item" id="twitter">
                                <a class="nav-link active" aria-current="page" href="#">
                                    <i class="ri-twitter-line"></i>
                                    <span data-feather="home"></span> Twitter
                                </a>
                            </li>
                            <li class="nav-item" id="wikipedia">
                                <a class="nav-link" href="#">
                                    <i class="ri-global-line"></i>
                                    <span data-feather="file"></span> Wikipedia
                                </a>
                            </li>
                            <li class="nav-item" id="facebook">
                                <a class="nav-link" href="#">
                                    <i class="ri-facebook-circle-fill"></i>
                                    <span data-feather="shopping-cart"></span> Facebook
                                </a>
                            </li>
                            <li class="nav-item" id="instagram">
                                <a class="nav-link" href="#">
                                    <i class="ri-instagram-line"></i>
                                    <span data-feather="shopping-cart"></span> Instagram
                                </a>
                            </li>
                            <li class="nav-item" id="spotify">
                                <a class="nav-link" href="#">
                                    <i class="ri-spotify-line"></i>
                                    <span data-feather="shopping-cart"></span> Spotify
                                </a>
                            </li>
                        </ul>

                        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                            <span>Saved reports</span>
                            <a class="link-secondary" href="#" aria-label="Add a new report">
                                <span data-feather="plus-circle"></span>
                            </a>
                        </h6>
                        <ul class="nav flex-column mb-2">
                            <li class="nav-item">
                                <a class="nav-link" href="#">
                                    <span data-feather="file-text"></span> Current month
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">
                                    <span data-feather="file-text"></span> Last quarter
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">
                                    <span data-feather="file-text"></span> Social engagement
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">
                                    <span data-feather="file-text"></span> Year-end sale
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>

                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">


                    <!-- ************************* -->
                    <div id="twitterPage">
                        <%- include('../pages/twitter'); %>
                    </div>
                    <div id="facebookPage">
                        <%- include('../pages/facebook'); %>
                    </div>
                    <div id="wikipediaPage">
                        <%- include('../pages/wikipedia'); %>
                    </div>
                    <div id="instagramPage">
                        <%- include('../pages/instagram'); %>
                    </div>
                    <div id="spotifyPage">
                        <%- include('../pages/spotify'); %>
                    </div>
                    <!-- ************************* -->
                </main>
            </div>
        </div>

        <!-- *********FOOTER************ -->
        <footer>
            <%- include('../partials/footer'); %>
        </footer>



        <!-- <script src="../assets/dist/js/bootstrap.bundle.min.js"></script> -->

        <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js" integrity="sha384-zNy6FEbO50N+Cg5wap8IKA4M/ZnLJgzc6w2NqACZaK0u0FXfOWRRJOnQtpZun8ha" crossorigin="anonymous"></script>
        <script src="../public/js/dashboard.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

        <!-- Modularizar esto de abajo -_-- -->

        <script>
            const search = document.getElementById('search');
            const getTweets = document.getElementById('getTweets');
            const output = document.getElementById('output');
            const mesSender = document.getElementById('mesSender');
            const getSpotify = document.getElementById('getSpotify');

            const getWiki = document.getElementById('getWiki');
            const searchWiki = document.getElementById('searchWiki');
            const searchSpotify = document.getElementById('searchSpotify');

            const facebook = document.getElementById('facebook');

            mesSender.addEventListener('submit', addComment);
            getTweets.addEventListener('click', getAllTweets);
            getSpotify.addEventListener('click', obtenerCanciones);

            getWiki.addEventListener('click', getAllWikis);

            // Al principio, solo aparece twitter
            $('#wikipediaPage').hide();
            $('#facebookPage').hide();
            $('#twitterPage').show();
            $('#instagramPage').hide();
            $('#spotifyPage').hide();

            $('#facebook').click(function() {
                console.log('facebook');
                $('#wikipediaPage').hide();
                $('#facebookPage').show();
                $('#twitterPage').hide();
                $('#instagramPage').hide();
                $('#spotifyPage').hide();
            })

            $('#twitter').click(function() {
                console.log('twitter');
                $('#wikipediaPage').hide();
                $('#facebookPage').hide();
                $('#twitterPage').show();
                $('#instagramPage').hide();
                $('#spotifyPage').hide();
            })

            $('#wikipedia').click(function() {
                console.log('wiki');
                $('#wikipediaPage').show();
                $('#facebookPage').hide();
                $('#twitterPage').hide();
                $('#instagramPage').hide();
                $('#spotifyPage').hide();
            })

            $('#instagram').click(function() {
                console.log('wiki');
                $('#wikipediaPage').hide();
                $('#facebookPage').hide();
                $('#twitterPage').hide();
                $('#instagramPage').show();
                $('#spotifyPage').hide();
            })

            $('#spotify').click(function() {
                console.log('spoti');
                $('#wikipediaPage').hide();
                $('#facebookPage').hide();
                $('#twitterPage').hide();
                $('#instagramPage').hide();
                $('#spotifyPage').show();
                listarNovedades();
            })

            // Postea un comentario en twitter
            function addComment() {
                event.preventDefault();
                let newTweetComment = {
                    "comment": document.getElementById('newMessage').value
                }
                console.log('new tweet es : ', newTweetComment);
                var xhr = new XMLHttpRequest();
                xhr.open("POST", 'http://localhost:3000/twitter/newtweet/', true);
                xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState != 4 || xhr.status != 200) return;
                    console.log('respuesta : ', xhr.responseText);
                }
                console.log('antes de xhr send', JSON.stringify(newTweetComment));
                xhr.send(JSON.stringify(newTweetComment));
            }

            // Busca y muestra twits en twitter
            function getAllTweets() {
                console.log('entra 3 : ');
                const url = 'http://localhost:3000/tweets/' + search.value;
                console.log('url es : ', url);
                fetch(url).then(function(response) {
                    return response.json()
                }).then(function(data) {
                    outputTweets(data.statuses)
                }).catch(function(error) {
                    console.log('error : ', JSON.stringify(error));
                })
            }

            function outputTweets(data) {
                output.innerHTML = ' ';
                data.forEach(function(item, i) {
                    console.log(item);
                    let hyper = `<a href="https://twitter.com/i/web/status/${item.id_str}" target="_blank">${item.text}</a>`;
                    let li = document.createElement('li');
                    let span = document.createElement('span');
                    span.innerHTML = `${hyper} <small>${item.user.name}</small> ♥ ${item.retweet_count}`;
                    li.appendChild(span);
                    output.appendChild(li);
                })
            }

            // ************* Wikipedia ********************
            // Busca y muestra twits en Facebook
            function getAllWikis() {
                console.log('entra getAllWikipedia : ');
                const url = 'http://localhost:3000/wikipedia/' + searchWiki.value;
                console.log('url es : ', url);
                /*fetch(url)
                    .then(response => response.json())
                    .then(function(data) {
                        outputWikipedia(data)
                    });*/

                fetch(url).then(function(response) {
                    return response.json()
                }).then(function(data) {
                    outputWikipedia(data)
                }).catch(function(error) {
                    console.log('errorWikipedia : ', error);
                })
            }

            function outputWikipedia(data) {
                console.log('entra outputWikipedia : ');
                outputWiki.innerHTML = ' ';
                // console.log(item);
                // let hyper = `<a href="https://twitter.com/i/web/status/${item.id_str}" target="_blank">${item.text}</a>`;
                let hyper = data;
                let li = document.createElement('li');
                let span = document.createElement('span');
                span.innerHTML = `${hyper} `;
                li.appendChild(span);
                outputWiki.appendChild(li);
            }
            // ************* Faceboook ********************
            // Busca y muestra twits en Facebook
            function getAllFacebook() {
                console.log('entra getAllFacebook : ');
                const url = 'http://localhost:3000/facebook/' + search.value;
                console.log('url es : ', url);
                fetch(url).then(function(response) {
                    return response.json()
                }).then(function(data) {
                    outputFacebook(data.statuses)
                }).catch(function(error) {
                    console.log('error : ', JSON.stringify(error));
                })
            }

            function outputFacebook(data) {
                outputFace.innerHTML = ' ';
                data.forEach(function(item, i) {
                    console.log(item);
                    let hyper = `<a href="https://twitter.com/i/web/status/${item.id_str}" target="_blank">${item.text}</a>`;
                    let li = document.createElement('li');
                    let span = document.createElement('span');
                    span.innerHTML = `${hyper} <small>${item.user.name}</small> ♥ ${item.retweet_count}`;
                    li.appendChild(span);
                    output.appendChild(li);
                })
            }

            // Publica en facebook
            function addCommentFace() {
                event.preventDefault();
                let newFacePublic = {
                    "comment": document.getElementById('newMessageFace').value
                }
                console.log('new face es : ', newFacePublic);
                var xhr = new XMLHttpRequest();
                xhr.open("POST", 'http://localhost:3000/facebook/comment/', true);
                xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState != 4 || xhr.status != 200) return;
                    console.log(xhr.responseText);
                }
                xhr.send(JSON.stringify(newFacePublic));
            }

            // ======================================
            //  Spotify
            // ======================================
            // Listar canciones
            function listarNovedades() {
                const url = 'http://localhost:3000/spotify';

                fetch(url).then(function(response) {
                    return response.json()
                }).then(function(data) {
                    outputSpotify(data)
                }).catch(function(error) {
                    console.log('errorSpoti : ', error);
                })
            }

            // Obtener canciones
            function obtenerCanciones(cancion) {
                const url = 'http://localhost:3000/spotify/' + searchSpotify.value;

                fetch(url).then(function(response) {
                    return response.json()
                }).then(function(data) {
                    armarTarjetasCanciones(data)
                }).catch(function(error) {
                    console.log('errorSpoti : ', error);
                })
            }

            // Arma las tarjetas novedades
            function outputSpotify(data) {
                $.each(data, function(i) {
                    for (var i = 0; i < data.albums.items.length; i++) {
                        var templateString = '<div class="col"><div class="card"><img src="' + data.albums.items[i].images[1].url + '" class="card-img-top"><div class="card-body"><h5 class="card-title">' + data.albums.items[i].name + '</h5><p class="card-text"> ' + data.albums.items[i].artists[0].name + '</p><a href="' + data.albums.items[i].external_urls.spotify + '" target="_blank" class="btn btn-primary">Escuchar</a></div></div></div></div>';
                        //You can get the prop of array with arr[i].Name
                        $('#outputSpotify').append(templateString);
                    }
                })
            }

            // Arma las tarjetas buscar cancion
            function armarTarjetasCanciones(data) {
                $("#outputSpotify").empty();
                $.each(data, function(i) {
                    for (var i = 0; i < 10; i++) {
                        var templateString = '<div class="col"><div class="card"><img src="' + data.tracks.items[i].album.images[1].url + '" class="card-img-top"><div class="card-body"><h5 class="card-title">' + data.tracks.items[i].name + '</h5><p class="card-text"> ' + data.tracks.items[i].artists[0].name + '</p><a href="' + data.tracks.items[i].external_urls.spotify + '" target="_blank" class="btn btn-primary">Escuchar</a></div></div></div></div>';
                        $('#outputSpotify').append(templateString);
                    }
                })
            }
        </script>
</body>

</html>